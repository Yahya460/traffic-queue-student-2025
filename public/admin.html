<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المدير - نظام الدور</title>
  <style>
    body{font-family:system-ui; background:#f3f4f6; margin:0; padding:16px}
    .card{background:#fff;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{margin:0 0 6px}
    small{color:#6b7280}
    input,select,button,textarea{font-family:inherit; font-size:15px}
    input,select,textarea{width:100%; padding:10px;border:1px solid #e5e7eb;border-radius:10px;box-sizing:border-box}
    button{padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
    button.danger{background:#b91c1c}
    button.gray{background:#374151}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:center}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
  </style>
</head>
<body>
  <h1>لوحة المدير - نظام الدور</h1>
  <small class="muted">إدارة المستخدمين · ملاحظات الموظفين · الإحصائيات · تصفير الدور · متابعة آخر ملاحظة عامة (تحديث تلقائي)</small>

  <div class="card" id="loginCard">
    <h3>دخول المدير</h3>
    <div class="row">
      <input id="adminSecret" placeholder="كلمة سر المدير (Admin Secret)" />
      <button onclick="saveSecret()">دخول</button>
    </div>
    <p class="muted">ملاحظة: سيتم حفظ كلمة السر في المتصفح لهذا الجهاز فقط.</p>
  </div>

  <div class="card" id="dashboard" style="display:none">
    <div class="row">
      <div>
        <h3>حالة التحديث</h3>
        <div class="pill" id="liveStatus">غير متصل</div>
        <p class="muted">آخر تحديث: <span id="lastUpdate">-</span></p>
      </div>
      <div style="text-align:left">
        <button class="gray" onclick="manualRefresh()">تحديث الآن</button>
      </div>
    </div>
  </div>

  <div class="card" id="usersCard" style="display:none">
    <h3>إدارة المستخدمين</h3>
    <div class="row">
      <input id="newUser" placeholder="اسم المستخدم الجديد" />
      <input id="newPass" placeholder="كلمة المرور" />
    </div>
    <div class="row">
      <select id="newRole">
        <option value="staff">موظف</option>
        <option value="admin">مدير</option>
      </select>
      <button onclick="addUser()">إضافة مستخدم</button>
    </div>

    <h4>قائمة المستخدمين</h4>
    <table>
      <thead>
        <tr><th>اسم المستخدم</th><th>الدور</th><th>تغيير كلمة المرور</th><th>حذف</th></tr>
      </thead>
      <tbody id="usersTbody"></tbody>
    </table>
  </div>

  <div class="card" id="staffNoteCard" style="display:none">
    <h3>ملاحظات للموظفين (لا تظهر على شاشة العرض)</h3>
    <div class="row">
      <select id="staffSelect"></select>
      <button onclick="loadStaffNote()">عرض الملاحظة الحالية</button>
    </div>
    <textarea id="staffNoteText" rows="3" placeholder="اكتب ملاحظة خاصة للموظف..."></textarea>
    <button onclick="saveStaffNote()">إرسال/تحديث الملاحظة</button>
    <p class="muted" id="staffNoteHint">اختر موظفًا لعرض أو إرسال الملاحظة.</p>
  </div>

  <div class="card" id="statsCard" style="display:none">
    <h3>الإحصائيات</h3>
    <p>إجمالي الأرقام التي تم نداؤها (اليوم): <b id="totalCalls">0</b></p>

    <h4>حسب الموظف</h4>
    <div id="perStaff"></div>

    <h4>حسب اليوم (سجل)</h4>
    <div id="perDay"></div>

    <hr />
    <p>الموظف صاحب آخر ملاحظة عامة على شاشة العرض: <b id="lastNoteStaff">-</b></p>
    <h4>محتوى آخر ملاحظة عامة على شاشة العرض</h4>
    <div class="card" style="background:#f9fafb" id="lastNoteTextBox">لا توجد ملاحظة عامة حاليًا.</div>
  </div>

  <div class="card" id="controlsCard" style="display:none">
    <h3>إدارة الدور</h3>
    <p class="muted">يمكنك تصفير الأرقام وإعادة النظام للبداية (0) أو تصفير الإحصائيات فقط.</p>
    <div class="row">
      <button class="danger" onclick="resetQueue()">تصفير الدور بالكامل</button>
      <button class="danger" onclick="resetStats()">تصفير الإحصائيات فقط</button>
    </div>
  </div>

  <p class="muted" style="text-align:center;margin-top:18px">
    جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام
  </p>

<script>
  let timer = null;

  function getSecret() {
    return localStorage.getItem('adminSecret') || '';
  }

  function saveSecret() {
    const s = document.getElementById('adminSecret').value.trim();
    if (!s) return alert('أدخل كلمة سر المدير');
    localStorage.setItem('adminSecret', s);
    init();
  }

  function init() {
    const s = getSecret();
    if (!s) return;

    document.getElementById('loginCard').style.display = 'none';
    ['dashboard','usersCard','staffNoteCard','statsCard','controlsCard'].forEach(id=>{
      document.getElementById(id).style.display='block';
    });

    manualRefresh();

    if (timer) clearInterval(timer);
    timer = setInterval(manualRefresh, 2000); // ✅ تحديث تلقائي
  }

  async function api(path, opts={}) {
    const adminSecret = getSecret();
    const url = path.includes('?') ? `${path}&adminSecret=${encodeURIComponent(adminSecret)}`
                                  : `${path}?adminSecret=${encodeURIComponent(adminSecret)}`;
    const res = await fetch(url, opts);
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.message || 'حدث خطأ');
    return data;
  }

  function setLive(ok) {
    const el = document.getElementById('liveStatus');
    el.textContent = ok ? 'متصل (تحديث تلقائي)' : 'غير متصل';
    el.style.background = ok ? '#dcfce7' : '#fee2e2';
    el.style.color = ok ? '#166534' : '#991b1b';
  }

  function nowStr() {
    return new Date().toLocaleString('ar-OM');
  }

  async function manualRefresh() {
    try {
      // users
      const users = await api('/api/users');
      renderUsers(users);
      fillStaffSelect(users);

      // stats
      const stats = await api('/api/stats');
      renderStats(stats);

      // state (ملاحظة عامة + صاحبها)
      const state = await fetch('/api/state').then(r=>r.json());
      document.getElementById('lastNoteStaff').textContent = state.lastNoteStaff || '-';
      document.getElementById('lastNoteTextBox').textContent = state.noteText ? state.noteText : 'لا توجد ملاحظة عامة حاليًا.';

      document.getElementById('lastUpdate').textContent = nowStr();
      setLive(true);
    } catch (e) {
      setLive(false);
    }
  }

  function renderUsers(users) {
    const tb = document.getElementById('usersTbody');
    tb.innerHTML = '';
    users.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>${u.role}</td>
        <td>
          <input placeholder="كلمة جديدة" id="pw_${u.username}" />
          <button class="gray" onclick="changePw('${u.username}')">حفظ</button>
        </td>
        <td><button class="danger" onclick="delUser('${u.username}')">حذف</button></td>
      `;
      tb.appendChild(tr);
    });
  }

  function fillStaffSelect(users){
    const sel = document.getElementById('staffSelect');
    const staff = users.filter(u=>u.role==='staff');
    const prev = sel.value;
    sel.innerHTML = `<option value="">اختر الموظف...</option>` + staff.map(s=>`<option value="${s.username}">${s.username}</option>`).join('');
    if (prev) sel.value = prev;
  }

  async function addUser(){
    const username = document.getElementById('newUser').value.trim();
    const password = document.getElementById('newPass').value.trim();
    const role = document.getElementById('newRole').value;
    if(!username || !password) return alert('أدخل اسم المستخدم وكلمة المرور');
    await api('/api/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password, role, adminSecret: getSecret() })
    });
    document.getElementById('newUser').value='';
    document.getElementById('newPass').value='';
    manualRefresh();
  }

  async function changePw(username){
    const newPassword = document.getElementById(`pw_${username}`).value.trim();
    if(!newPassword) return alert('أدخل كلمة جديدة');
    await api(`/api/users/${encodeURIComponent(username)}/password`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ newPassword, adminSecret: getSecret() })
    });
    manualRefresh();
  }

  async function delUser(username){
    await api(`/api/users/${encodeURIComponent(username)}`, { method:'DELETE' });
    manualRefresh();
  }

  async function saveStaffNote(){
    const staffName = document.getElementById('staffSelect').value;
    const note = document.getElementById('staffNoteText').value;
    if(!staffName) return alert('اختر موظف');
    await api('/api/staff-note', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ staffName, note, adminSecret: getSecret() })
    });
    document.getElementById('staffNoteHint').textContent = 'تم إرسال/تحديث الملاحظة.';
  }

  async function loadStaffNote(){
    const staffName = document.getElementById('staffSelect').value;
    if(!staffName) return alert('اختر موظف');
    const r = await fetch(`/api/staff-note?staffName=${encodeURIComponent(staffName)}`);
    const data = await r.json();
    document.getElementById('staffNoteText').value = data.note || '';
    document.getElementById('staffNoteHint').textContent = 'تم عرض الملاحظة الحالية.';
  }

  function renderStats(stats){
    document.getElementById('totalCalls').textContent = stats.totalCalls || 0;

    const ps = stats.perStaff || {};
    document.getElementById('perStaff').innerHTML =
      Object.keys(ps).length
        ? `<ul>${Object.entries(ps).map(([k,v])=>`<li><b>${k}</b>: ${v}</li>`).join('')}</ul>`
        : `<div class="muted">لا توجد بيانات بعد.</div>`;

    const pd = stats.perDay || {};
    const days = Object.keys(pd).sort().reverse();
    document.getElementById('perDay').innerHTML =
      days.length
        ? `<ul>${days.map(d=>`<li><b>${d}</b>: ${pd[d]}</li>`).join('')}</ul>`
        : `<div class="muted">لا توجد بيانات بعد.</div>`;
  }

  async function resetQueue(){
    await api('/api/reset', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ adminSecret: getSecret() })
    });
    manualRefresh();
  }

  async function resetStats(){
    await api('/api/reset-stats', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ adminSecret: getSecret() })
    });
    manualRefresh();
  }

  init();
</script>
</body>
</html>
