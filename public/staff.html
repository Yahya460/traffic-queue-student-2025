<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة الموظف - نظام الدور</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f3f4f6;
      padding: 16px;
    }
    h1 {
      text-align: center;
      margin-bottom: 4px;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 14px;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 8px;
      font-size: 13px;
      color: #4b5563;
      gap: 8px;
      align-items: center;
    }
    .top-bar span {
      font-weight: 500;
    }
    .logout-btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      background: #e5e7eb;
      color: #111827;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      font-family: inherit;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    button {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      margin-top: 10px;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: #ffffff;
    }
    .current-box {
      text-align: center;
      padding: 10px;
      border-radius: 14px;
      background: #eff6ff;
      margin-top: 10px;
    }
    .current-label {
      font-size: 15px;
      color: #1d4ed8;
    }
    .current-number {
      font-size: 60px;
      font-weight: 800;
      color: #111827;
    }
    .current-gender {
      margin-top: 4px;
      font-size: 15px;
      color: #374151;
    }
    .history-list {
      list-style: none;
      padding: 0;
      margin: 10px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 14px;
    }
    .history-item {
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .note-preview {
      margin-top: 6px;
      padding: 8px;
      border-radius: 10px;
      border: 1px dashed #fecaca;
      background: #fef2f2;
      color: #b91c1c;
      font-size: 13px;
      min-height: 40px;
    }
    .manager-note {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      border: 1px dashed #bfdbfe;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 13px;
      min-height: 40px;
      white-space: pre-line;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 13px;
      color: #6b7280;
    }
    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>لوحة الموظف - نظام الدور</h1>
  <div class="subtitle">
    من هذه الصفحة يتم اختيار رقم التلميذ وندائه، مع إرسال الملاحظات العامة، واستقبال ملاحظات المدير الخاصة بالموظف
  </div>

  <div class="top-bar">
    <div>الموظف: <span id="staffNameLabel">غير معروف</span></div>
    <button class="logout-btn" onclick="logout()">تسجيل خروج</button>
  </div>

  <div class="layout">
    <!-- التحكم في أرقام التلاميذ -->
    <div class="card">
      <h2>التحكم في أرقام التلاميذ</h2>

      <label>رقم التلميذ</label>
      <input id="studentNumberInput" type="number" placeholder="اكتب رقم التلميذ الذي تريد مناداته" />

      <label>تصنيف التلميذ</label>
      <select id="genderSelect">
        <option value="">اختر التصنيف...</option>
        <option value="men">رجال</option>
        <option value="women">نساء</option>
      </select>

      <div class="current-box">
        <div class="current-label">رقم التلميذ الحالي</div>
        <div id="currentNumber" class="current-number">0</div>
        <div id="currentGenderLabel" class="current-gender">-</div>
      </div>

      <ul class="history-list" id="historyList"></ul>

      <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
        <button class="btn-primary" onclick="callStudent()">نداء التلميذ</button>
        <button class="btn-secondary" onclick="repeatStudent()">إعادة نداء التلميذ الحالي</button>
      </div>
    </div>

    <!-- الملاحظات -->
    <div class="card">
      <h2>إدارة الملاحظات</h2>
      <label>ملاحظة عامة تظهر على شاشة العرض للمتدربين</label>
      <textarea id="noteInput" placeholder="اكتب هنا أي ملاحظة تود عرضها للمتدربين..."></textarea>
      <button class="btn-primary" onclick="sendNote()">إرسال الملاحظة لشاشة العرض</button>
      <button class="btn-secondary" onclick="clearNote()">مسح الملاحظة من شاشة العرض</button>

      <div class="note-preview" id="notePreview">
        لا توجد ملاحظة مرسلة حاليًا على شاشة العرض.
      </div>

      <h3 style="margin-top:14px; font-size:16px;">ملاحظة من المدير لك</h3>
      <div class="manager-note" id="managerNoteBox">
        لا توجد ملاحظة من المدير حاليًا.
      </div>
    </div>
  </div>

  <div class="footer">
    جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام
  </div>

  <script>
    function getStaffName() {
      const name = localStorage.getItem('staffName');
      if (!name) {
        window.location.href = 'login.html';
        return null;
      }
      return name;
    }

    function initStaffName() {
      const name = getStaffName();
      if (!name) return;
      document.getElementById('staffNameLabel').textContent = name;
    }

    function logout() {
      localStorage.removeItem('staffName');
      window.location.href = 'login.html';
    }

    function genderArabic(gender) {
      if (gender === 'men') return 'رجال';
      if (gender === 'women') return 'نساء';
      return '-';
    }

    function updateStateUI(state) {
      const currentEl = document.getElementById('currentNumber');
      const historyEl = document.getElementById('historyList');
      const notePreview = document.getElementById('notePreview');
      const genderLabel = document.getElementById('currentGenderLabel');

      currentEl.textContent = state.currentNumber ?? 0;
      genderLabel.textContent = genderArabic(state.currentGender);

      historyEl.innerHTML = '';
      (state.history || []).forEach((num) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.textContent = num;
        historyEl.appendChild(li);
      });

      const note = (state.noteText || '').trim();
      if (!note) {
        notePreview.textContent = 'لا توجد ملاحظة مرسلة حاليًا على شاشة العرض.';
      } else {
        notePreview.textContent = note;
      }
    }

    function fetchState() {
      fetch('/api/state')
        .then((res) => res.json())
        .then((data) => updateStateUI(data))
        .catch((err) => console.error(err));
    }

    function callStudent() {
      const staffName = getStaffName();
      if (!staffName) return;

      const studentNumber = document.getElementById('studentNumberInput').value.trim();
      const gender = document.getElementById('genderSelect').value;

      if (!studentNumber) {
        alert('يرجى إدخال رقم التلميذ.');
        return;
      }
      if (!gender) {
        alert('يرجى اختيار تصنيف التلميذ (رجال/نساء).');
        return;
      }

      fetch('/api/next', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ staffName, studentNumber, gender })
      })
        .then((res) => res.json())
        .then((data) => {
          updateStateUI(data);
        })
        .catch((err) => console.error(err));
    }

    function repeatStudent() {
      fetch('/api/repeat', {
        method: 'POST'
      })
        .then((res) => res.json())
        .then((data) => updateStateUI(data))
        .catch((err) => console.error(err));
    }

    function sendNote() {
      const note = document.getElementById('noteInput').value;
      const staffName = getStaffName();
      if (!staffName) return;

      fetch('/api/note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ note, staffName })
      })
        .then((res) => res.json())
        .then((data) => {
          document.getElementById('notePreview').textContent =
            data.noteText || 'لا توجد ملاحظة مرسلة حاليًا على شاشة العرض.';
        })
        .catch((err) => console.error(err));
    }

    function clearNote() {
      document.getElementById('noteInput').value = '';
      sendNote();
    }

    function fetchManagerNote() {
      const staffName = getStaffName();
      if (!staffName) return;
      fetch('/api/staff-note?staffName=' + encodeURIComponent(staffName))
        .then((res) => res.json())
        .then((data) => {
          const box = document.getElementById('managerNoteBox');
          const note = (data.note || '').trim();
          if (!note) {
            box.textContent = 'لا توجد ملاحظة من المدير حاليًا.';
          } else {
            box.textContent = note;
          }
        })
        .catch((err) => console.error(err));
    }

    initStaffName();
    fetchState();
    fetchManagerNote();
    setInterval(fetchState, 3000);
    setInterval(fetchManagerNote, 5000);
  </script>
</body>
</html>